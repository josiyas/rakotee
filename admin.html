<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rakotee Admin</title>
  <link rel="stylesheet" href="admin-style.css" />
</head>
<body>
  <div class="admin-container">
    <!-- LOGIN SCREEN -->
    <div id="loginSection" class="card">
      <h2>Admin Login</h2>
      <input type="email" id="loginEmail" placeholder="Email" required />
      <input type="password" id="loginPassword" placeholder="Password" required />
      <button id="loginBtn">Login</button>
      <p id="loginError"></p>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminDashboard" class="hidden">
      <div class="top-bar">
        <h2>Rakotee Admin Panel</h2>
        <button id="logoutBtn">Logout</button>
      </div>

      <!-- Order List -->
      <div id="orderList" class="card">
        <h3>Orders</h3>
        <table id="ordersTable" style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Amount</th>
              <th>Paid</th>
              <th>Delivered</th>
              <th>Payment Method</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
            <tr><td colspan="8" style="text-align:center;">No orders yet.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Upload Form -->
      <form id="productForm" class="card">
        <h3>Upload New Product</h3>
        <input type="text" id="name" placeholder="Product Name" required />
        <input type="number" id="price" placeholder="Product Price" required />
        <input type="file" id="imageFile" accept="image/*" required />
        <button type="submit">Upload</button>
        <p id="uploadStatus"></p>
      </form>

      <!-- Product List -->
      <div id="productList" class="product-list card">
        <h3>Existing Products</h3>
        <div id="productsContainer"></div>
      </div>
    </div>
  </div>

  <!-- Firebase Admin Script -->
  <script type="module">

    const loginSection = document.getElementById("loginSection");
    const adminDashboard = document.getElementById("adminDashboard");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginError = document.getElementById("loginError");

    // Admin login with MongoDB
    loginBtn.onclick = async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        const res = await fetch('http://localhost:5000/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.token) {
          localStorage.setItem('rakotee_admin_token', data.token);
          loginSection.style.display = "none";
          adminDashboard.classList.remove("hidden");
          loadProducts();
          loadOrders();
        } else {
          loginError.textContent = data.error || 'Login failed.';
        }
      } catch (err) {
        loginError.textContent = "Login failed: " + err.message;
      }
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem('rakotee_admin_token');
      loginSection.style.display = "block";
      adminDashboard.classList.add("hidden");
    };

    // Upload product
    const form = document.getElementById("productForm");
    const status = document.getElementById("uploadStatus");

    form.onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const price = parseFloat(document.getElementById("price").value);
      const file = document.getElementById("imageFile").files[0];

      try {
        // Upload image to backend
        const formData = new FormData();
        formData.append('name', name);
        formData.append('price', price);
        formData.append('image', file);
        const token = localStorage.getItem('rakotee_admin_token');
        const res = await fetch('http://localhost:5000/api/admin/products', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });
        const data = await res.json();
        if (res.ok) {
          status.textContent = "✅ Product uploaded!";
          form.reset();
          loadProducts();
        } else {
          status.textContent = data.error || "❌ Failed to upload product.";
        }
      } catch (err) {
        console.error(err);
        status.textContent = "❌ Failed to upload product.";
      }
    };

    // Load and show products
    async function loadProducts() {
      const container = document.getElementById("productsContainer");
      container.innerHTML = "";
      const token = localStorage.getItem('rakotee_admin_token');
  const res = await fetch('http://localhost:5000/api/admin/products', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      const products = data.products || [];
      if (!products.length) {
        container.innerHTML = '<p>No products found.</p>';
        return;
      }
      products.forEach(product => {
        const productCard = document.createElement("div");
        productCard.className = "product-card";
        productCard.innerHTML = `
          <img src="${product.image}" alt="${product.name}" />
          <h4 contenteditable="true">${product.name}</h4>
          <p contenteditable="true">R ${product.price}</p>
          <button data-id="${product._id}" class="updateBtn">Save</button>
          <button data-id="${product._id}" class="deleteBtn">Delete</button>
        `;
        container.appendChild(productCard);
      });

      // Edit & delete
      container.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = async () => {
          const token = localStorage.getItem('rakotee_admin_token');
          await fetch(`http://localhost:5000/api/admin/products/${btn.dataset.id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          loadProducts();
        };
      });

      container.querySelectorAll(".updateBtn").forEach(btn => {
        btn.onclick = async () => {
          const card = btn.parentElement;
          const newName = card.querySelector("h4").textContent.trim();
          const newPrice = parseFloat(card.querySelector("p").textContent.replace(/[^\d.]/g, ''));
          const token = localStorage.getItem('rakotee_admin_token');
          await fetch(`http://localhost:5000/api/admin/products/${btn.dataset.id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ name: newName, price: newPrice })
          });
          loadProducts();
        };
      });
    }

    // Load and show orders
    async function loadOrders() {
      const token = localStorage.getItem('rakotee_admin_token');
      const res = await fetch('http://localhost:5000/api/order/all', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const orders = await res.json();
      const tbody = document.getElementById("ordersBody");
      tbody.innerHTML = '';
      if (!orders.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No orders yet.</td></tr>';
        return;
      }
      orders.forEach(order => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${order._id}</td>
          <td>${order.name}</td>
          <td>${order.email}</td>
          <td>R${order.cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2)}</td>
          <td class="${order.paid ? 'paid' : 'unpaid'}">${order.paid ? 'Paid' : 'Unpaid'}</td>
          <td class="${order.delivered ? 'delivered' : 'not-delivered'}">${order.delivered ? 'Delivered' : 'Not Delivered'}</td>
          <td>${order.paymentMethod || '-'}</td>
          <td>
            <button onclick="markDelivered('${order._id}')" ${order.delivered ? 'disabled' : ''}>Mark Delivered</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    window.markDelivered = async function(orderId) {
      const token = localStorage.getItem('rakotee_admin_token');
      await fetch(`http://localhost:5000/api/order/deliver/${orderId}`, {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      loadOrders();
    }
  </script>
</body>
</html>